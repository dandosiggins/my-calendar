// Save each repeating instance to Firebase
                if (isFirebaseEnabled) {
                    await saveEventToFirebase(dateKey, instanceData);
                }<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Cloud Calendar</title>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, getDocs, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // TODO: Replace with your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAKnXHWejoL5QYwg09boKMRLvlobQGKr7o",
      authDomain: "my-calendar-app-e4c69.firebaseapp.com",
      projectId: "my-calendar-app-e4c69",
      storageBucket: "my-calendar-app-e4c69.firebasestorage.app",
      messagingSenderId: "772407805545",
      appId: "1:772407805545:web:1663020ec5b7bd154fc4f8"
    };

        try {
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            
            // Make Firebase functions globally available
            window.db = db;
            window.firestore = { collection, addDoc, updateDoc, deleteDoc, doc, getDocs, onSnapshot, query, orderBy };
            window.firebaseInitialized = true;
            
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.log('Firebase not configured or error:', error);
            window.firebaseInitialized = false;
        }
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .calendar-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .nav-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        .nav-btn:hover {
            background: #0056b3;
        }
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #ddd;
            border: 1px solid #ddd;
        }
        .day-header {
            background: #f8f9fa;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }
        .day-cell {
            background: white;
            min-height: 80px;
            padding: 5px;
            cursor: pointer;
            position: relative;
        }
        .day-cell:hover {
            background: #f8f9fa;
        }
        .day-cell.today {
            background: #e3f2fd;
        }
        .day-number {
            font-weight: bold;
            margin-bottom: 3px;
        }
        .event {
            color: white;
            font-size: 11px;
            padding: 2px 4px;
            margin: 1px 0;
            border-radius: 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .event-work { background: #007bff; }
        .event-personal { background: #28a745; }
        .event-health { background: #ffc107; color: #000; }
        .event-social { background: #e83e8c; }
        .event-finance { background: #6f42c1; }
        .event-travel { background: #20c997; }
        .event-education { background: #dc3545; }
        .event-guitar { background: #fd7e14; }
        .event-kj { background: #6610f2; }
        .event-daniel { background: #198754; }
        .event-other { background: #6c757d; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 20px;
            width: 400px;
            border-radius: 8px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #545b62;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .event-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .event-item {
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            background: #f8f9fa;
        }
        .event-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .event-time {
            color: #007bff;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .event-desc {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .event-actions {
            display: flex;
            gap: 10px;
        }
        .small-btn {
            padding: 5px 10px;
            font-size: 12px;
        }
        .sync-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            color: white;
            font-size: 12px;
            z-index: 1000;
        }
        .sync-online {
            background: #28a745;
        }
        .sync-offline {
            background: #dc3545;
        }
        .sync-syncing {
            background: #ffc107;
            color: #000;
        }
        .firebase-setup {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .firebase-setup h3 {
            color: #856404;
            margin-top: 0;
        }
        .firebase-setup p, .firebase-setup li {
            color: #856404;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="calendar-container">
        <!-- Sync Status Indicator -->
        <div id="syncStatus" class="sync-status sync-offline">üì° Setting up...</div>

        <!-- Firebase Setup Instructions -->
        <div id="firebaseSetup" class="firebase-setup">
            <h3>üîß Enable Cloud Sync (Optional)</h3>
            <p><strong>Your calendar works perfectly without cloud sync!</strong> To enable syncing across devices:</p>
            <ol>
                <li>Go to <a href="https://firebase.google.com" target="_blank">firebase.google.com</a> and create a project</li>
                <li>Enable Firestore Database in "test mode"</li>
                <li>Go to Project Settings ‚Üí Add web app ‚Üí Copy the config</li>
                <li>Replace the firebaseConfig in this code with your config</li>
            </ol>
            <button onclick="hideFirebaseInstructions()" style="margin-top: 10px; padding: 5px 10px; background: #6c757d; color: white; border: none; border-radius: 3px;">Hide Instructions</button>
        </div>
        <div class="header">
            <h1>My Calendar</h1>
            <div>
                <button class="nav-btn" onclick="previousMonth()">‚Üê Previous</button>
                <span id="monthYear" style="margin: 0 20px; font-size: 18px; font-weight: bold;"></span>
                <button class="nav-btn" onclick="nextMonth()">Next ‚Üí</button>
            </div>
        </div>
        
        <!-- Category Filter -->
        <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <span style="font-weight: bold;">Categories:</span>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; font-size: 12px;">
                        <span style="display: flex; align-items: center; gap: 3px;"><span style="width: 12px; height: 12px; background: #007bff; border-radius: 2px; display: inline-block;"></span>Work</span>
                        <span style="display: flex; align-items: center; gap: 3px;"><span style="width: 12px; height: 12px; background: #28a745; border-radius: 2px; display: inline-block;"></span>Personal</span>
                        <span style="display: flex; align-items: center; gap: 3px;"><span style="width: 12px; height: 12px; background: #ffc107; border-radius: 2px; display: inline-block;"></span>Health</span>
                        <span style="display: flex; align-items: center; gap: 3px;"><span style="width: 12px; height: 12px; background: #e83e8c; border-radius: 2px; display: inline-block;"></span>Social</span>
                        <span style="display: flex; align-items: center; gap: 3px;"><span style="width: 12px; height: 12px; background: #6f42c1; border-radius: 2px; display: inline-block;"></span>Finance</span>
                        <span style="display: flex; align-items: center; gap: 3px;"><span style="width: 12px; height: 12px; background: #20c997; border-radius: 2px; display: inline-block;"></span>Travel</span>
                        <span style="display: flex; align-items: center; gap: 3px;"><span style="width: 12px; height: 12px; background: #dc3545; border-radius: 2px; display: inline-block;"></span>Education</span>
                        <span style="display: flex; align-items: center; gap: 3px;"><span style="width: 12px; height: 12px; background: #fd7e14; border-radius: 2px; display: inline-block;"></span>Guitar</span>
                        <span style="display: flex; align-items: center; gap: 3px;"><span style="width: 12px; height: 12px; background: #6610f2; border-radius: 2px; display: inline-block;"></span>KJ</span>
                        <span style="display: flex; align-items: center; gap: 3px;"><span style="width: 12px; height: 12px; background: #198754; border-radius: 2px; display: inline-block;"></span>Daniel</span>
                        <span style="display: flex; align-items: center; gap: 3px;"><span style="width: 12px; height: 12px; background: #6c757d; border-radius: 2px; display: inline-block;"></span>Other</span>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label style="font-weight: bold;">Filter:</label>
                    <select id="categoryFilter" onchange="filterByCategory()" style="padding: 5px;">
                        <option value="all">All Categories</option>
                        <option value="work">üíº Work</option>
                        <option value="personal">üè† Personal</option>
                        <option value="health">‚öïÔ∏è Health</option>
                        <option value="social">üë• Social</option>
                        <option value="finance">üí∞ Finance</option>
                        <option value="travel">‚úàÔ∏è Travel</option>
                        <option value="education">üìö Education</option>
                        <option value="guitar">üé∏ Guitar</option>
                        <option value="kj">üë§ KJ</option>
                        <option value="daniel">üë® Daniel</option>
                        <option value="other">üìù Other</option>
                    </select>
                </div>
            </div>
        </div>
        <div id="calendar" class="calendar"></div>
    </div>

    <!-- Day View Modal -->
    <div id="dayModal" class="modal">
        <div class="modal-content">
            <h2 id="dayTitle">Day View</h2>
            <button class="btn" onclick="showAddEventModal()" style="width: 100%; margin-bottom: 15px;">
                + Add New Event
            </button>
            <div id="eventList" class="event-list">
                <!-- Events will be populated here -->
            </div>
            <button class="btn btn-secondary" onclick="closeDayModal()">Close</button>
        </div>
    </div>

    <!-- Add/Edit Event Modal -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <h2 id="eventModalTitle">Add Event</h2>
            <div class="form-group">
                <label>Event Title *</label>
                <input type="text" id="eventTitle" placeholder="Enter event title">
            </div>
            <div class="form-group">
                <label>Category</label>
                <select id="eventCategory">
                    <option value="work">üíº Work</option>
                    <option value="personal">üè† Personal</option>
                    <option value="health">‚öïÔ∏è Health</option>
                    <option value="social">üë• Social</option>
                    <option value="finance">üí∞ Finance</option>
                    <option value="travel">‚úàÔ∏è Travel</option>
                    <option value="education">üìö Education</option>
                    <option value="guitar">üé∏ Guitar</option>
                    <option value="kj">üë§ KJ</option>
                    <option value="daniel">üë® Daniel</option>
                    <option value="other">üìù Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Time</label>
                <input type="time" id="eventTime">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="eventDesc" rows="3" placeholder="Enter description (optional)"></textarea>
            </div>
            <div class="form-group">
                <label>Repeat</label>
                <select id="eventRepeat" onchange="toggleRepeatOptions()">
                    <option value="none">No repeat</option>
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                    <option value="yearly">Yearly</option>
                </select>
            </div>
            <div id="repeatOptions" class="form-group" style="display: none;">
                <label>Repeat until (optional)</label>
                <input type="date" id="repeatUntil" placeholder="Leave empty to repeat indefinitely">
                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    Leave empty to repeat indefinitely (up to 1 year)
                </div>
            </div>
            <button class="btn" onclick="saveEvent()">Save Event</button>
            <button class="btn btn-secondary" onclick="closeEventModal()">Cancel</button>
            <div id="saveMessage" style="color: green; margin-top: 10px; display: none;">Event saved!</div>
        </div>
    </div>

    <script>
        // Global variables
        let currentDate = new Date();
        let events = {};
        let selectedDate = '';
        let editingIndex = -1;
        let currentCategoryFilter = 'all';
        let isFirebaseEnabled = false;
        let eventsListener = null;

        // Category definitions
        const categories = {
            work: { name: 'Work', icon: 'üíº', color: '#007bff' },
            personal: { name: 'Personal', icon: 'üè†', color: '#28a745' },
            health: { name: 'Health', icon: '‚öïÔ∏è', color: '#ffc107' },
            social: { name: 'Social', icon: 'üë•', color: '#e83e8c' },
            finance: { name: 'Finance', icon: 'üí∞', color: '#6f42c1' },
            travel: { name: 'Travel', icon: '‚úàÔ∏è', color: '#20c997' },
            education: { name: 'Education', icon: 'üìö', color: '#dc3545' },
            guitar: { name: 'Guitar', icon: 'üé∏', color: '#fd7e14' },
            kj: { name: 'KJ', icon: 'üë§', color: '#6610f2' },
            daniel: { name: 'Daniel', icon: 'üë®', color: '#198754' },
            other: { name: 'Other', icon: 'üìù', color: '#6c757d' }
        };

        // Load events from localStorage or Firebase
        function loadEvents() {
            // First try to load from localStorage
            const saved = localStorage.getItem('calendarEvents');
            if (saved) {
                try {
                    events = JSON.parse(saved);
                    console.log('Loaded events from localStorage:', Object.keys(events).length, 'dates');
                } catch (e) {
                    console.error('Error loading events from localStorage:', e);
                    events = {};
                }
            }
            
            // Then check if Firebase is available and load from there
            setTimeout(checkFirebaseAndLoad, 1000);
        }

        // Check Firebase status and load events
        function checkFirebaseAndLoad() {
            if (window.firebaseInitialized && window.db && window.firestore) {
                console.log('Firebase is available, setting up cloud sync...');
                isFirebaseEnabled = true;
                updateSyncStatus('syncing', '‚è≥ Loading from cloud...');
                hideFirebaseInstructions();
                loadEventsFromFirebase();
            } else {
                console.log('Firebase not configured, using local storage only');
                isFirebaseEnabled = false;
                updateSyncStatus('offline', 'üíæ Local Only');
                showFirebaseInstructions();
            }
        }

        // Load events from Firebase with real-time updates
        function loadEventsFromFirebase() {
            try {
                const eventsCollection = window.firestore.collection(window.db, 'events');
                const q = window.firestore.query(eventsCollection, window.firestore.orderBy('date'));
                
                // Set up real-time listener
                eventsListener = window.firestore.onSnapshot(q, (snapshot) => {
                    const firebaseEvents = {};
                    
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        if (!firebaseEvents[data.date]) {
                            firebaseEvents[data.date] = [];
                        }
                        firebaseEvents[data.date].push({
                            id: doc.id,
                            ...data
                        });
                    });
                    
                    // Merge with localStorage events (Firebase takes priority)
                    events = { ...events, ...firebaseEvents };
                    
                    updateSyncStatus('online', '‚òÅÔ∏è Synced');
                    renderCalendar();
                    console.log('Loaded', snapshot.size, 'events from Firebase');
                }, (error) => {
                    console.error('Error loading from Firebase:', error);
                    updateSyncStatus('offline', '‚ùå Sync Error');
                });
                
            } catch (error) {
                console.error('Error setting up Firebase listener:', error);
                updateSyncStatus('offline', '‚ùå Setup Error');
            }
        }

        // Save events (to both localStorage and Firebase)
        function saveEvents() {
            try {
                // Always save to localStorage as backup
                localStorage.setItem('calendarEvents', JSON.stringify(events));
                console.log('Saved to localStorage');
                return true;
            } catch (e) {
                console.error('Error saving to localStorage:', e);
                alert('Error saving event. Please try again.');
                return false;
            }
        }

        // Save single event to Firebase
        async function saveEventToFirebase(dateKey, eventData) {
            if (!isFirebaseEnabled) return null;
            
            try {
                const eventsCollection = window.firestore.collection(window.db, 'events');
                const docRef = await window.firestore.addDoc(eventsCollection, {
                    date: dateKey,
                    ...eventData,
                    createdAt: new Date(),
                    updatedAt: new Date()
                });
                
                console.log('Saved event to Firebase with ID:', docRef.id);
                return docRef.id;
                
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                throw error; // Re-throw to be caught by Promise.all
            }
        }

        // Update event in Firebase
        async function updateEventInFirebase(eventId, eventData, dateKey) {
            if (!isFirebaseEnabled || !eventId) return;
            
            try {
                updateSyncStatus('syncing', '‚è≥ Updating cloud...');
                
                const eventDoc = window.firestore.doc(window.db, 'events', eventId);
                await window.firestore.updateDoc(eventDoc, {
                    date: dateKey,
                    ...eventData,
                    updatedAt: new Date()
                });
                
                updateSyncStatus('online', '‚òÅÔ∏è Updated in cloud');
                console.log('Updated event in Firebase');
                
            } catch (error) {
                console.error('Error updating Firebase:', error);
                updateSyncStatus('offline', '‚ùå Update failed');
            }
        }

        // Delete event from Firebase
        async function deleteEventFromFirebase(eventId) {
            if (!isFirebaseEnabled || !eventId) return;
            
            try {
                updateSyncStatus('syncing', '‚è≥ Deleting from cloud...');
                
                const eventDoc = window.firestore.doc(window.db, 'events', eventId);
                await window.firestore.deleteDoc(eventDoc);
                
                updateSyncStatus('online', '‚òÅÔ∏è Deleted from cloud');
                console.log('Deleted event from Firebase');
                
            } catch (error) {
                console.error('Error deleting from Firebase:', error);
                updateSyncStatus('offline', '‚ùå Delete failed');
            }
        }

        // Update sync status indicator
        function updateSyncStatus(status, text) {
            const indicator = document.getElementById('syncStatus');
            indicator.className = `sync-status sync-${status}`;
            indicator.textContent = text;
        }

        // Show/hide Firebase setup instructions
        function showFirebaseInstructions() {
            const setup = document.getElementById('firebaseSetup');
            if (setup) setup.style.display = 'block';
        }

        function hideFirebaseInstructions() {
            const setup = document.getElementById('firebaseSetup');
            if (setup) setup.style.display = 'none';
        }

        // Format date for storage (YYYY-MM-DD)
        function formatDate(year, month, day) {
            return year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
        }

        // Render the calendar
        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            const monthYear = document.getElementById('monthYear');
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            monthYear.textContent = monthNames[currentDate.getMonth()] + ' ' + currentDate.getFullYear();
            calendar.innerHTML = '';
            
            // Add day headers
            dayNames.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';
                dayHeader.textContent = day;
                calendar.appendChild(dayHeader);
            });
            
            // Get calendar info
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
            const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            const today = new Date();
            
            // Add empty cells for days before first day of month
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'day-cell';
                emptyCell.style.backgroundColor = '#f5f5f5';
                calendar.appendChild(emptyCell);
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell';
                
                // Check if today
                if (currentDate.getFullYear() === today.getFullYear() && 
                    currentDate.getMonth() === today.getMonth() && 
                    day === today.getDate()) {
                    dayCell.classList.add('today');
                }
                
                // Add day number
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayCell.appendChild(dayNumber);
                
                // Add events for this day
                const dateKey = formatDate(currentDate.getFullYear(), currentDate.getMonth(), day);
                if (events[dateKey]) {
                    const filteredEvents = events[dateKey].filter(event => {
                        if (currentCategoryFilter === 'all') return true;
                        return (event.category || 'work') === currentCategoryFilter;
                    });
                    
                    filteredEvents.forEach(event => {
                        const eventDiv = document.createElement('div');
                        const category = event.category || 'work';
                        eventDiv.className = 'event event-' + category;
                        
                        const categoryIcon = categories[category]?.icon || 'üìù';
                        const eventText = event.time ? event.time + ' ' + event.title : event.title;
                        const repeatIcon = event.isRepeating ? 'üîÑ ' : '';
                        eventDiv.textContent = repeatIcon + categoryIcon + ' ' + eventText;
                        dayCell.appendChild(eventDiv);
                    });
                }
                
                // Add click handler
                dayCell.onclick = () => openDayView(dateKey, day);
                
                calendar.appendChild(dayCell);
            }
        }

        // Open day view
        function openDayView(dateKey, day) {
            selectedDate = dateKey;
            const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('dayTitle').textContent = date.toLocaleDateString('en-US', options);
            
            showDayEvents(dateKey);
            document.getElementById('dayModal').style.display = 'block';
        }

        // Show events for selected day
        function showDayEvents(dateKey) {
            const eventList = document.getElementById('eventList');
            
            // Clear the event list first
            eventList.innerHTML = '';
            
            if (!events[dateKey] || events[dateKey].length === 0) {
                const noEventsMessage = document.createElement('p');
                noEventsMessage.style.textAlign = 'center';
                noEventsMessage.style.color = '#666';
                noEventsMessage.style.padding = '20px';
                noEventsMessage.textContent = 'No events for this day';
                eventList.appendChild(noEventsMessage);
                return;
            }
            
            events[dateKey].forEach((event, index) => {
                const eventItem = document.createElement('div');
                eventItem.className = 'event-item';
                
                const category = event.category || 'work';
                const categoryIcon = categories[category]?.icon || 'üìù';
                const categoryName = categories[category]?.name || 'Other';
                const repeatIcon = event.isRepeating ? 'üîÑ ' : '';
                
                eventItem.innerHTML = `
                    <div class="event-title">${repeatIcon}${categoryIcon} ${event.title}</div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Category: ${categoryName}${event.isRepeating ? ' ‚Ä¢ Repeating Event' : ''}</div>
                    ${event.time ? `<div class="event-time">‚è∞ ${formatTime(event.time)}</div>` : ''}
                    ${event.description ? `<div class="event-desc">${event.description}</div>` : ''}
                    <div class="event-actions">
                        <button class="btn small-btn" onclick="editEvent(${index})">Edit</button>
                        <button class="btn btn-danger small-btn" onclick="deleteEvent(${index})">Delete</button>
                        ${event.isRepeating ? '<button class="btn btn-danger small-btn" onclick="deleteEntireSeries(' + index + ')">Delete Series</button>' : ''}
                    </div>
                `;
                
                eventList.appendChild(eventItem);
            });
        }

        // Format time for display
        function formatTime(timeString) {
            if (!timeString) return '';
            const [hours, minutes] = timeString.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
            return `${displayHour}:${minutes} ${ampm}`;
        }

        // Show add event modal
        function showAddEventModal() {
            editingIndex = -1;
            document.getElementById('eventModalTitle').textContent = 'Add Event';
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventCategory').value = 'work';
            document.getElementById('eventTime').value = '';
            document.getElementById('eventDesc').value = '';
            document.getElementById('eventRepeat').value = 'none';
            document.getElementById('repeatUntil').value = '';
            document.getElementById('repeatOptions').style.display = 'none';
            document.getElementById('saveMessage').style.display = 'none';
            closeDayModal();
            document.getElementById('eventModal').style.display = 'block';
        }

        // Toggle repeat options visibility
        function toggleRepeatOptions() {
            const repeatValue = document.getElementById('eventRepeat').value;
            const repeatOptions = document.getElementById('repeatOptions');
            repeatOptions.style.display = repeatValue !== 'none' ? 'block' : 'none';
        }

        // Edit event
        function editEvent(index) {
            if (!events[selectedDate] || !events[selectedDate][index]) return;
            
            editingIndex = index;
            const event = events[selectedDate][index];
            
            document.getElementById('eventModalTitle').textContent = 'Edit Event';
            document.getElementById('eventTitle').value = event.title;
            document.getElementById('eventCategory').value = event.category || 'work';
            document.getElementById('eventTime').value = event.time || '';
            document.getElementById('eventDesc').value = event.description || '';
            document.getElementById('eventRepeat').value = event.repeat || 'none';
            document.getElementById('repeatUntil').value = event.repeatUntil || '';
            
            // Show/hide repeat options based on current setting
            toggleRepeatOptions();
            
            document.getElementById('saveMessage').style.display = 'none';
            
            closeDayModal();
            document.getElementById('eventModal').style.display = 'block';
        }

        // Delete event
        function deleteEvent(index) {
            if (!events[selectedDate] || !events[selectedDate][index]) return;
            
            if (confirm('Are you sure you want to delete this event?')) {
                const eventToDelete = events[selectedDate][index];
                
                // Delete from Firebase if it has an ID
                if (eventToDelete.id) {
                    deleteEventFromFirebase(eventToDelete.id);
                }
                
                events[selectedDate].splice(index, 1);
                if (events[selectedDate].length === 0) {
                    delete events[selectedDate];
                }
                saveEvents();
                renderCalendar();
                showDayEvents(selectedDate);
                openDayView(selectedDate, parseInt(selectedDate.split('-')[2]));
            }
        }

        // Save event
        async function saveEvent() {
            const title = document.getElementById('eventTitle').value.trim();
            const category = document.getElementById('eventCategory').value;
            const time = document.getElementById('eventTime').value;
            const description = document.getElementById('eventDesc').value.trim();
            const repeat = document.getElementById('eventRepeat').value;
            const repeatUntil = document.getElementById('repeatUntil').value;
            
            if (!title) {
                alert('Please enter an event title');
                return;
            }
            
            const eventData = {
                title: title,
                category: category,
                time: time,
                description: description,
                repeat: repeat !== 'none' ? repeat : null,
                repeatUntil: repeatUntil || null,
                isRepeating: repeat !== 'none'
            };
            
            if (!events[selectedDate]) {
                events[selectedDate] = [];
            }
            
            if (editingIndex >= 0) {
                // Edit existing event
                const existingEvent = events[selectedDate][editingIndex];
                events[selectedDate][editingIndex] = eventData;
                console.log('Updated event at index', editingIndex);
                
                // Update in Firebase if it has an ID
                if (existingEvent.id) {
                    updateEventInFirebase(existingEvent.id, eventData, selectedDate);
                }
            } else {
                // Add new event
                events[selectedDate].push(eventData);
                console.log('Added new event');
                
                // Save to Firebase
                if (isFirebaseEnabled) {
                    try {
                        updateSyncStatus('syncing', '‚è≥ Saving to cloud...');
                        await saveEventToFirebase(selectedDate, eventData);
                        updateSyncStatus('online', '‚úÖ Saved to cloud');
                        setTimeout(() => {
                            updateSyncStatus('online', '‚òÅÔ∏è Synced');
                        }, 2000);
                    } catch (error) {
                        updateSyncStatus('offline', '‚ùå Save failed');
                    }
                }
                
                // Create repeating instances if needed
                if (repeat !== 'none') {
                    await createRepeatingEvents(selectedDate, eventData);
                }
            }
            
            if (saveEvents()) {
                document.getElementById('saveMessage').style.display = 'block';
                setTimeout(() => {
                    closeEventModal();
                    renderCalendar();
                    openDayView(selectedDate, parseInt(selectedDate.split('-')[2]));
                }, 1000);
            }
        }

        // Create repeating events
        function createRepeatingEvents(startDate, eventData) {
            const startDateObj = new Date(startDate + 'T00:00:00'); // Add time to avoid timezone issues
            const endDate = eventData.repeatUntil ? new Date(eventData.repeatUntil + 'T23:59:59') : null;
            const maxInstances = 365; // Safety limit
            let currentDate = new Date(startDateObj);
            let instanceCount = 0;
            
            console.log('Creating repeating events:', {
                startDate,
                repeat: eventData.repeat,
                endDate: endDate ? endDate.toDateString() : 'No end date'
            });
            
            // Create instances based on repeat type
            while (instanceCount < maxInstances) {
                // Calculate next date
                switch (eventData.repeat) {
                    case 'daily':
                        currentDate.setUTCDate(currentDate.getUTCDate() + 1);
                        break;
                    case 'weekly':
                        currentDate.setUTCDate(currentDate.getUTCDate() + 7);
                        break;
                    case 'monthly':
                        // Handle month rollover properly
                        const currentMonth = currentDate.getUTCMonth();
                        const currentYear = currentDate.getUTCFullYear();
                        const currentDay = currentDate.getUTCDate();
                        
                        let nextMonth = currentMonth + 1;
                        let nextYear = currentYear;
                        
                        if (nextMonth > 11) {
                            nextMonth = 0;
                            nextYear++;
                        }
                        
                        // Handle cases where next month has fewer days (e.g., Jan 31 -> Feb 28)
                        const daysInNextMonth = new Date(nextYear, nextMonth + 1, 0).getDate();
                        const nextDay = Math.min(currentDay, daysInNextMonth);
                        
                        currentDate.setUTCFullYear(nextYear);
                        currentDate.setUTCMonth(nextMonth);
                        currentDate.setUTCDate(nextDay);
                        break;
                    case 'yearly':
                        // Handle leap year properly
                        const nextYearForYearly = currentDate.getUTCFullYear() + 1;
                        const monthForYearly = currentDate.getUTCMonth();
                        const dayForYearly = currentDate.getUTCDate();
                        
                        // Handle Feb 29 on non-leap years
                        if (monthForYearly === 1 && dayForYearly === 29) {
                            // Feb 29 - check if next year is leap year
                            const isNextYearLeap = (nextYearForYearly % 4 === 0 && nextYearForYearly % 100 !== 0) || (nextYearForYearly % 400 === 0);
                            if (!isNextYearLeap) {
                                currentDate.setUTCDate(28); // Move to Feb 28
                            }
                        }
                        
                        currentDate.setUTCFullYear(nextYearForYearly);
                        break;
                    default:
                        console.error('Unknown repeat type:', eventData.repeat);
                        return;
                }
                
                console.log(`Instance ${instanceCount + 1}: ${currentDate.toDateString()}`);
                
                // Stop if we've reached the end date
                if (endDate && currentDate > endDate) {
                    console.log('Reached end date, stopping');
                    break;
                }
                
                // Stop if we're more than 2 years in the future (safety check)
                const twoYearsFromNow = new Date();
                twoYearsFromNow.setFullYear(twoYearsFromNow.getFullYear() + 2);
                if (currentDate > twoYearsFromNow) {
                    console.log('Reached 2-year limit, stopping');
                    break;
                }
                
                // Create the repeating instance
                const dateKey = formatDate(currentDate.getUTCFullYear(), currentDate.getUTCMonth(), currentDate.getUTCDate());
                
                if (!events[dateKey]) {
                    events[dateKey] = [];
                }
                
                // Create instance without repeat settings (to avoid infinite loops)
                const instanceData = {
                    ...eventData,
                    repeat: null,
                    repeatUntil: null,
                    isRepeating: true,
                    originalTitle: eventData.title // Track original for series deletion
                };
                
                events[dateKey].push(instanceData);
                instanceCount++;
            }
            
            console.log(`Created ${instanceCount} repeating instances for "${eventData.title}"`);
        }

        // Delete entire series of repeating events
        function deleteEntireSeries(index) {
            if (!events[selectedDate] || !events[selectedDate][index]) return;
            
            const event = events[selectedDate][index];
            const originalTitle = event.originalTitle || event.title;
            
            if (confirm(`Are you sure you want to delete the entire series "${originalTitle}"? This will remove all past and future occurrences.`)) {
                updateSyncStatus('syncing', '‚è≥ Deleting series...');
                
                // Collect all Firebase IDs to delete
                const firebaseIdsToDelete = [];
                
                // Remove all events with the same original title
                Object.keys(events).forEach(dateKey => {
                    events[dateKey] = events[dateKey].filter(e => {
                        const eventTitle = e.originalTitle || e.title;
                        if (eventTitle === originalTitle) {
                            // Collect Firebase ID if exists
                            if (e.id) {
                                firebaseIdsToDelete.push(e.id);
                            }
                            return false; // Remove this event
                        }
                        return true; // Keep this event
                    });
                    
                    // Clean up empty date entries
                    if (events[dateKey].length === 0) {
                        delete events[dateKey];
                    }
                });
                
                // Delete from Firebase
                if (isFirebaseEnabled && firebaseIdsToDelete.length > 0) {
                    firebaseIdsToDelete.forEach(id => {
                        deleteEventFromFirebase(id);
                    });
                }
                
                saveEvents();
                renderCalendar();
                showDayEvents(selectedDate);
                openDayView(selectedDate, parseInt(selectedDate.split('-')[2]));
                
                updateSyncStatus('online', '‚òÅÔ∏è Series deleted');
            }
        }

        // Category filtering
        function filterByCategory() {
            currentCategoryFilter = document.getElementById('categoryFilter').value;
            renderCalendar();
        }

        // Close modals
        function closeDayModal() {
            document.getElementById('dayModal').style.display = 'none';
        }

        function closeEventModal() {
            document.getElementById('eventModal').style.display = 'none';
        }

        // Navigation
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        // Initialize
        loadEvents();
        renderCalendar();
        
        // Cleanup Firebase listener when page unloads
        window.addEventListener('beforeunload', () => {
            if (eventsListener) {
                eventsListener();
            }
        });
    </script>
</body>
</html>
