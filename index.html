async function updateEventInFirebase(eventId, eventData) {
            if (!isFirebaseEnabled || !eventId) return;
            
            try {
                const eventDoc = window.firestore.doc(window.db, 'events', eventId);
                await window.firestore.updateDoc(eventDoc, {
                    title: eventData.title,
                    category: eventData.category,
                    time: eventData.time,
                    description: eventData.description,
                    repeat: eventData.repeat,
                    repeatUntil: eventData.repeatUntil,
                    isRepeating: eventData.isRepeating,
                    updatedAt: new Date()
                });
                
                console.log('Updated event in Firebase:', eventId);
            } catch (error) {
                console.error('Error updating Firebase:', error);
                throw error;
            }
        }<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Cloud Calendar</title>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, getDocs, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyAKnXHWejoL5QYwg09boKMRLvlobQGKr7o",
            authDomain: "my-calendar-app-e4c69.firebaseapp.com",
            projectId: "my-calendar-app-e4c69",
            storageBucket: "my-calendar-app-e4c69.firebasestorage.app",
            messagingSenderId: "772407805545",
            appId: "1:772407805545:web:1663020ec5b7bd154fc4f8"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            
            window.db = db;
            window.firestore = { collection, addDoc, updateDoc, deleteDoc, doc, getDocs, onSnapshot, query, orderBy };
            window.firebaseInitialized = true;
            
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.log('Firebase not configured:', error);
            window.firebaseInitialized = false;
        }
    </script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .calendar-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .nav-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        .nav-btn:hover {
            background: #0056b3;
        }
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #ddd;
            border: 1px solid #ddd;
        }
        .day-header {
            background: #f8f9fa;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }
        .day-cell {
            background: white;
            min-height: 80px;
            padding: 5px;
            cursor: pointer;
            position: relative;
        }
        .day-cell:hover {
            background: #f8f9fa;
        }
        .day-cell.today {
            background: #e3f2fd;
        }
        .day-number {
            font-weight: bold;
            margin-bottom: 3px;
        }
        .event {
            color: white;
            font-size: 11px;
            padding: 2px 4px;
            margin: 1px 0;
            border-radius: 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .event-work { background: #007bff; }
        .event-personal { background: #28a745; }
        .event-health { background: #ffc107; color: #000; }
        .event-social { background: #e83e8c; }
        .event-finance { background: #6f42c1; }
        .event-travel { background: #20c997; }
        .event-education { background: #dc3545; }
        .event-guitar { background: #fd7e14; }
        .event-kj { background: #6610f2; }
        .event-daniel { background: #198754; }
        .event-other { background: #6c757d; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 20px;
            width: 400px;
            border-radius: 8px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #545b62;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .event-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .event-item {
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            background: #f8f9fa;
        }
        .event-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .event-time {
            color: #007bff;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .event-desc {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .event-actions {
            display: flex;
            gap: 10px;
        }
        .small-btn {
            padding: 5px 10px;
            font-size: 12px;
        }
        .sync-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            color: white;
            font-size: 12px;
            z-index: 1000;
        }
        .sync-online {
            background: #28a745;
        }
        .sync-offline {
            background: #dc3545;
        }
        .sync-syncing {
            background: #ffc107;
            color: #000;
        }
        .category-filter {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="calendar-container">
        <!-- Sync Status -->
        <div id="syncStatus" class="sync-status sync-offline">üì° Setting up...</div>

        <div class="header">
            <h1>My Cloud Calendar</h1>
            <div>
                <button class="nav-btn" onclick="previousMonth()">‚Üê Previous</button>
                <span id="monthYear" style="margin: 0 20px; font-size: 18px; font-weight: bold;"></span>
                <button class="nav-btn" onclick="nextMonth()">Next ‚Üí</button>
            </div>
        </div>
        
        <!-- Category Filter -->
        <div class="category-filter">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-weight: bold;">Filter:</span>
                <select id="categoryFilter" onchange="filterByCategory()">
                    <option value="all">All Categories</option>
                    <option value="work">üíº Work</option>
                    <option value="personal">üè† Personal</option>
                    <option value="health">‚öïÔ∏è Health</option>
                    <option value="social">üë• Social</option>
                    <option value="finance">üí∞ Finance</option>
                    <option value="travel">‚úàÔ∏è Travel</option>
                    <option value="education">üìö Education</option>
                    <option value="guitar">üé∏ Guitar</option>
                    <option value="kj">üë§ KJ</option>
                    <option value="daniel">üë® Daniel</option>
                    <option value="other">üìù Other</option>
                </select>
            </div>
        </div>

        <div id="calendar" class="calendar"></div>
    </div>

    <!-- Day View Modal -->
    <div id="dayModal" class="modal">
        <div class="modal-content">
            <h2 id="dayTitle">Day View</h2>
            <button class="btn" onclick="showAddEventModal()" style="width: 100%; margin-bottom: 15px;">
                + Add New Event
            </button>
            <div id="eventList" class="event-list"></div>
            <button class="btn btn-secondary" onclick="closeDayModal()">Close</button>
        </div>
    </div>

    <!-- Add/Edit Event Modal -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <h2 id="eventModalTitle">Add Event</h2>
            <div class="form-group">
                <label>Event Title *</label>
                <input type="text" id="eventTitle" placeholder="Enter event title">
            </div>
            <div class="form-group">
                <label>Category</label>
                <select id="eventCategory">
                    <option value="work">üíº Work</option>
                    <option value="personal">üè† Personal</option>
                    <option value="health">‚öïÔ∏è Health</option>
                    <option value="social">üë• Social</option>
                    <option value="finance">üí∞ Finance</option>
                    <option value="travel">‚úàÔ∏è Travel</option>
                    <option value="education">üìö Education</option>
                    <option value="guitar">üé∏ Guitar</option>
                    <option value="kj">üë§ KJ</option>
                    <option value="daniel">üë® Daniel</option>
                    <option value="other">üìù Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Time</label>
                <input type="time" id="eventTime">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="eventDesc" rows="3" placeholder="Enter description (optional)"></textarea>
            </div>
            <div class="form-group">
                <label>Repeat</label>
                <select id="eventRepeat" onchange="toggleRepeatOptions()">
                    <option value="none">No repeat</option>
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                    <option value="yearly">Yearly</option>
                </select>
            </div>
            <div id="repeatOptions" class="form-group" style="display: none;">
                <label>Repeat until (optional)</label>
                <input type="date" id="repeatUntil">
                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    Leave empty to repeat indefinitely
                </div>
            </div>
            <button class="btn" onclick="saveEvent()">Save Event</button>
            <button class="btn btn-secondary" onclick="closeEventModal()">Cancel</button>
            <div id="saveMessage" style="color: green; margin-top: 10px; display: none;">Event saved!</div>
        </div>
    </div>

    <script>
        let currentDate = new Date();
        let events = {};
        let selectedDate = '';
        let editingIndex = -1;
        let currentCategoryFilter = 'all';
        let isFirebaseEnabled = false;

        const categories = {
            work: { name: 'Work', icon: 'üíº' },
            personal: { name: 'Personal', icon: 'üè†' },
            health: { name: 'Health', icon: '‚öïÔ∏è' },
            social: { name: 'Social', icon: 'üë•' },
            finance: { name: 'Finance', icon: 'üí∞' },
            travel: { name: 'Travel', icon: '‚úàÔ∏è' },
            education: { name: 'Education', icon: 'üìö' },
            guitar: { name: 'Guitar', icon: 'üé∏' },
            kj: { name: 'KJ', icon: 'üë§' },
            daniel: { name: 'Daniel', icon: 'üë®' },
            other: { name: 'Other', icon: 'üìù' }
        };

        function loadEvents() {
            const saved = localStorage.getItem('calendarEvents');
            if (saved) {
                try {
                    events = JSON.parse(saved);
                    console.log('Loaded events from localStorage');
                } catch (e) {
                    console.error('Error loading events:', e);
                    events = {};
                }
            }
            
            setTimeout(checkFirebase, 1000);
        }

        function checkFirebase() {
            if (window.firebaseInitialized && window.db) {
                console.log('Firebase available, enabling cloud sync');
                isFirebaseEnabled = true;
                updateSyncStatus('syncing', '‚è≥ Loading from cloud...');
                loadFromFirebase();
            } else {
                console.log('Firebase not configured, using local storage only');
                isFirebaseEnabled = false;
                updateSyncStatus('offline', 'üíæ Local Only');
            }
        }

        function loadFromFirebase() {
            try {
                const eventsCollection = window.firestore.collection(window.db, 'events');
                window.firestore.onSnapshot(eventsCollection, (snapshot) => {
                    const firebaseEvents = {};
                    
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        if (!firebaseEvents[data.date]) {
                            firebaseEvents[data.date] = [];
                        }
                        firebaseEvents[data.date].push({
                            id: doc.id,
                            ...data
                        });
                    });
                    
                    events = { ...events, ...firebaseEvents };
                    updateSyncStatus('online', '‚òÅÔ∏è Synced');
                    renderCalendar();
                });
            } catch (error) {
                console.error('Firebase error:', error);
                updateSyncStatus('offline', '‚ùå Sync Error');
            }
        }

        function saveEvents() {
            try {
                localStorage.setItem('calendarEvents', JSON.stringify(events));
                return true;
            } catch (e) {
                console.error('Error saving:', e);
                return false;
            }
        }

        async function saveToFirebase(dateKey, eventData) {
            if (!isFirebaseEnabled) return null;
            
            try {
                const eventsCollection = window.firestore.collection(window.db, 'events');
                const docRef = await window.firestore.addDoc(eventsCollection, {
                    date: dateKey,
                    ...eventData,
                    createdAt: new Date()
                });
                return docRef.id;
            } catch (error) {
                console.error('Firebase save error:', error);
                return null;
            }
        }

        function updateSyncStatus(status, text) {
            const indicator = document.getElementById('syncStatus');
            indicator.className = `sync-status sync-${status}`;
            indicator.textContent = text;
        }

        function formatDate(year, month, day) {
            return year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
        }

        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            const monthYear = document.getElementById('monthYear');
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            monthYear.textContent = monthNames[currentDate.getMonth()] + ' ' + currentDate.getFullYear();
            calendar.innerHTML = '';
            
            dayNames.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';
                dayHeader.textContent = day;
                calendar.appendChild(dayHeader);
            });
            
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
            const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            const today = new Date();
            
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'day-cell';
                emptyCell.style.backgroundColor = '#f5f5f5';
                calendar.appendChild(emptyCell);
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell';
                
                if (currentDate.getFullYear() === today.getFullYear() && 
                    currentDate.getMonth() === today.getMonth() && 
                    day === today.getDate()) {
                    dayCell.classList.add('today');
                }
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayCell.appendChild(dayNumber);
                
                const dateKey = formatDate(currentDate.getFullYear(), currentDate.getMonth(), day);
                if (events[dateKey]) {
                    const filteredEvents = events[dateKey].filter(event => {
                        if (currentCategoryFilter === 'all') return true;
                        return (event.category || 'work') === currentCategoryFilter;
                    });
                    
                    filteredEvents.forEach(event => {
                        const eventDiv = document.createElement('div');
                        const category = event.category || 'work';
                        eventDiv.className = 'event event-' + category;
                        
                        const categoryIcon = categories[category]?.icon || 'üìù';
                        const repeatIcon = event.isRepeating ? 'üîÑ ' : '';
                        const eventText = event.time ? event.time + ' ' + event.title : event.title;
                        eventDiv.textContent = repeatIcon + categoryIcon + ' ' + eventText;
                        dayCell.appendChild(eventDiv);
                    });
                }
                
                dayCell.onclick = () => openDayView(dateKey, day);
                calendar.appendChild(dayCell);
            }
        }

        function openDayView(dateKey, day) {
            selectedDate = dateKey;
            const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('dayTitle').textContent = date.toLocaleDateString('en-US', options);
            
            showDayEvents(dateKey);
            document.getElementById('dayModal').style.display = 'block';
        }

        function showDayEvents(dateKey) {
            const eventList = document.getElementById('eventList');
            eventList.innerHTML = '';
            
            if (!events[dateKey] || events[dateKey].length === 0) {
                const noEventsMessage = document.createElement('p');
                noEventsMessage.style.textAlign = 'center';
                noEventsMessage.style.color = '#666';
                noEventsMessage.textContent = 'No events for this day';
                eventList.appendChild(noEventsMessage);
                return;
            }
            
            events[dateKey].forEach((event, index) => {
                const eventItem = document.createElement('div');
                eventItem.className = 'event-item';
                
                const category = event.category || 'work';
                const categoryIcon = categories[category]?.icon || 'üìù';
                const repeatIcon = event.isRepeating ? 'üîÑ ' : '';
                
                eventItem.innerHTML = `
                    <div class="event-title">${repeatIcon}${categoryIcon} ${event.title}</div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Category: ${categories[category]?.name || 'Other'}</div>
                    ${event.time ? `<div class="event-time">‚è∞ ${formatTime(event.time)}</div>` : ''}
                    ${event.description ? `<div class="event-desc">${event.description}</div>` : ''}
                    <div class="event-actions">
                        <button class="btn small-btn" onclick="editEvent(${index})">Edit</button>
                        <button class="btn btn-danger small-btn" onclick="deleteEvent(${index})">Delete</button>
                    </div>
                `;
                
                eventList.appendChild(eventItem);
            });
        }

        function formatTime(timeString) {
            if (!timeString) return '';
            const [hours, minutes] = timeString.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
            return `${displayHour}:${minutes} ${ampm}`;
        }

        function showAddEventModal() {
            editingIndex = -1;
            document.getElementById('eventModalTitle').textContent = 'Add Event';
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventCategory').value = 'work';
            document.getElementById('eventTime').value = '';
            document.getElementById('eventDesc').value = '';
            document.getElementById('eventRepeat').value = 'none';
            document.getElementById('repeatUntil').value = '';
            document.getElementById('repeatOptions').style.display = 'none';
            document.getElementById('saveMessage').style.display = 'none';
            closeDayModal();
            document.getElementById('eventModal').style.display = 'block';
        }

        function toggleRepeatOptions() {
            const repeatValue = document.getElementById('eventRepeat').value;
            const repeatOptions = document.getElementById('repeatOptions');
            repeatOptions.style.display = repeatValue !== 'none' ? 'block' : 'none';
        }

        function editEvent(index) {
            if (!events[selectedDate] || !events[selectedDate][index]) return;
            
            editingIndex = index;
            const event = events[selectedDate][index];
            
            document.getElementById('eventModalTitle').textContent = 'Edit Event';
            document.getElementById('eventTitle').value = event.title;
            document.getElementById('eventCategory').value = event.category || 'work';
            document.getElementById('eventTime').value = event.time || '';
            document.getElementById('eventDesc').value = event.description || '';
            document.getElementById('eventRepeat').value = event.repeat || 'none';
            document.getElementById('repeatUntil').value = event.repeatUntil || '';
            
            toggleRepeatOptions();
            document.getElementById('saveMessage').style.display = 'none';
            
            closeDayModal();
            document.getElementById('eventModal').style.display = 'block';
        }

        async function saveEvent() {
            const title = document.getElementById('eventTitle').value.trim();
            const category = document.getElementById('eventCategory').value;
            const time = document.getElementById('eventTime').value;
            const description = document.getElementById('eventDesc').value.trim();
            const repeat = document.getElementById('eventRepeat').value;
            const repeatUntil = document.getElementById('repeatUntil').value;
            
            if (!title) {
                alert('Please enter an event title');
                return;
            }
            
            const eventData = {
                title: title,
                category: category,
                time: time,
                description: description,
                repeat: repeat !== 'none' ? repeat : null,
                repeatUntil: repeatUntil || null,
                isRepeating: repeat !== 'none'
            };
            
            if (!events[selectedDate]) {
                events[selectedDate] = [];
            }
            
            if (editingIndex >= 0) {
                // PRESERVE the existing Firebase ID when editing
                const existingEvent = events[selectedDate][editingIndex];
                const updatedEvent = {
                    ...eventData,
                    id: existingEvent.id // Keep the Firebase ID!
                };
                
                events[selectedDate][editingIndex] = updatedEvent;
                
                // Update in Firebase if it has an ID
                if (existingEvent.id) {
                    try {
                        updateSyncStatus('syncing', '‚è≥ Updating cloud...');
                        await updateEventInFirebase(existingEvent.id, eventData);
                        updateSyncStatus('online', '‚úÖ Updated in cloud');
                        setTimeout(() => updateSyncStatus('online', '‚òÅÔ∏è Synced'), 2000);
                    } catch (error) {
                        updateSyncStatus('offline', '‚ùå Update failed');
                    }
                }
            } else {
                // Add new event
                events[selectedDate].push(eventData);
                
                // Save to Firebase and get the ID
                if (isFirebaseEnabled) {
                    try {
                        updateSyncStatus('syncing', '‚è≥ Saving to cloud...');
                        const firebaseId = await saveToFirebase(selectedDate, eventData);
                        
                        // Add the Firebase ID to the local event
                        if (firebaseId) {
                            const lastEventIndex = events[selectedDate].length - 1;
                            events[selectedDate][lastEventIndex].id = firebaseId;
                        }
                        
                        updateSyncStatus('online', '‚úÖ Saved to cloud');
                        setTimeout(() => updateSyncStatus('online', '‚òÅÔ∏è Synced'), 2000);
                    } catch (error) {
                        updateSyncStatus('offline', '‚ùå Save failed');
                    }
                }
                
                if (repeat !== 'none') {
                    createRepeatingEvents(selectedDate, eventData);
                }
            }
            
            if (saveEvents()) {
                document.getElementById('saveMessage').style.display = 'block';
                setTimeout(() => {
                    closeEventModal();
                    renderCalendar();
                    openDayView(selectedDate, parseInt(selectedDate.split('-')[2]));
                }, 1000);
            }
        }

        function createRepeatingEvents(startDate, eventData) {
            const startDateObj = new Date(startDate + 'T00:00:00');
            const endDate = eventData.repeatUntil ? new Date(eventData.repeatUntil + 'T23:59:59') : null;
            const maxInstances = 100;
            let currentDate = new Date(startDateObj);
            let instanceCount = 0;
            
            while (instanceCount < maxInstances) {
                switch (eventData.repeat) {
                    case 'daily':
                        currentDate.setUTCDate(currentDate.getUTCDate() + 1);
                        break;
                    case 'weekly':
                        currentDate.setUTCDate(currentDate.getUTCDate() + 7);
                        break;
                    case 'monthly':
                        currentDate.setUTCMonth(currentDate.getUTCMonth() + 1);
                        break;
                    case 'yearly':
                        currentDate.setUTCFullYear(currentDate.getUTCFullYear() + 1);
                        break;
                    default:
                        return;
                }
                
                if (endDate && currentDate > endDate) break;
                
                const oneYearFromNow = new Date();
                oneYearFromNow.setFullYear(oneYearFromNow.getFullYear() + 1);
                if (currentDate > oneYearFromNow) break;
                
                const dateKey = formatDate(currentDate.getUTCFullYear(), currentDate.getUTCMonth(), currentDate.getUTCDate());
                
                if (!events[dateKey]) {
                    events[dateKey] = [];
                }
                
                const instanceData = {
                    title: eventData.title,
                    category: eventData.category,
                    time: eventData.time,
                    description: eventData.description,
                    repeat: null,
                    repeatUntil: null,
                    isRepeating: true,
                    originalTitle: eventData.title
                };
                
                events[dateKey].push(instanceData);
                
                if (isFirebaseEnabled) {
                    const firebaseId = await saveToFirebase(dateKey, instanceData);
                    if (firebaseId) {
                        // Add Firebase ID to the instance we just created
                        events[dateKey][events[dateKey].length - 1].id = firebaseId;
                    }
                }
                
                instanceCount++;
            }
            
            console.log(`Created ${instanceCount} repeating instances`);
        }

        function deleteEvent(index) {
            if (!events[selectedDate] || !events[selectedDate][index]) return;
            
            if (confirm('Are you sure you want to delete this event?')) {
                const eventToDelete = events[selectedDate][index];
                
                // Delete from Firebase first if it has an ID
                if (eventToDelete.id && isFirebaseEnabled) {
                    deleteFromFirebase(eventToDelete.id);
                }
                
                // Remove from local events
                events[selectedDate].splice(index, 1);
                if (events[selectedDate].length === 0) {
                    delete events[selectedDate];
                }
                
                saveEvents();
                renderCalendar();
                showDayEvents(selectedDate);
                openDayView(selectedDate, parseInt(selectedDate.split('-')[2]));
            }
        }

        async function deleteFromFirebase(eventId) {
            try {
                updateSyncStatus('syncing', '‚è≥ Deleting from cloud...');
                const eventDoc = window.firestore.doc(window.db, 'events', eventId);
                await window.firestore.deleteDoc(eventDoc);
                updateSyncStatus('online', '‚úÖ Deleted from cloud');
                setTimeout(() => updateSyncStatus('online', '‚òÅÔ∏è Synced'), 2000);
                console.log('Deleted event from Firebase:', eventId);
            } catch (error) {
                console.error('Error deleting from Firebase:', error);
                updateSyncStatus('offline', '‚ùå Delete failed');
            }
        }

        function filterByCategory() {
            currentCategoryFilter = document.getElementById('categoryFilter').value;
            renderCalendar();
        }

        function closeDayModal() {
            document.getElementById('dayModal').style.display = 'none';
        }

        function closeEventModal() {
            document.getElementById('eventModal').style.display = 'none';
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        loadEvents();
        renderCalendar();
    </script>
</body>
</html>
